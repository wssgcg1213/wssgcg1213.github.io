<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>使用C++模块为Nodejs添彩助力 | Zero&#39;s Corner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言了解node的开发者清楚, node不是一门语言, 而是一个平台.  多亏了libuv屏蔽了操作系统层面的差异, 优秀的js语言特性(有些人不以为然, 不评论)能让node做很多事情. 我们知道node擅长的部分是异步IO, 这里还是要感谢libuv, 但是不擅长的是CPU密集型操作, 这作为解释型脚本语言的弱项, 静态语言则反之表现出色. 
Node的C/C++模块在朴老师的深浅node中指">
<meta property="og:type" content="article">
<meta property="og:title" content="使用C++模块为Nodejs添彩助力">
<meta property="og:url" content="https://blog.zeroling.com/2015/12/07/shi-yong-cmo-kuai-wei-nodejstian-cai-zhu-li/index.html">
<meta property="og:site_name" content="Zero's Corner">
<meta property="og:description" content="前言了解node的开发者清楚, node不是一门语言, 而是一个平台.  多亏了libuv屏蔽了操作系统层面的差异, 优秀的js语言特性(有些人不以为然, 不评论)能让node做很多事情. 我们知道node擅长的部分是异步IO, 这里还是要感谢libuv, 但是不擅长的是CPU密集型操作, 这作为解释型脚本语言的弱项, 静态语言则反之表现出色. 
Node的C/C++模块在朴老师的深浅node中指">
<meta property="og:image" content="https://dn-redrock.qbox.me/cet-decoder-cc.png">
<meta property="og:image" content="https://dn-redrock.qbox.me/cet-decoder-cc.png">
<meta property="og:image" content="https://dn-redrock.qbox.me/cet-decoder-cc-1.png">
<meta property="og:updated_time" content="2015-12-06T17:54:52.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="使用C++模块为Nodejs添彩助力">
<meta name="twitter:description" content="前言了解node的开发者清楚, node不是一门语言, 而是一个平台.  多亏了libuv屏蔽了操作系统层面的差异, 优秀的js语言特性(有些人不以为然, 不评论)能让node做很多事情. 我们知道node擅长的部分是异步IO, 这里还是要感谢libuv, 但是不擅长的是CPU密集型操作, 这作为解释型脚本语言的弱项, 静态语言则反之表现出色. 
Node的C/C++模块在朴老师的深浅node中指">
  
    <link rel="alternative" href="/atom.xml" title="Zero&#39;s Corner" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css" type="text/css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Zero&#39;s Corner</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://blog.zeroling.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-shi-yong-cmo-kuai-wei-nodejstian-cai-zhu-li" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/07/shi-yong-cmo-kuai-wei-nodejstian-cai-zhu-li/" class="article-date">
  <time datetime="2015-12-06T17:54:52.000Z" itemprop="datePublished">2015-12-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      使用C++模块为Nodejs添彩助力
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p><img src="https://dn-redrock.qbox.me/cet-decoder-cc.png" alt="cover-image"></p>
<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>了解node的开发者清楚, node不是一门语言, 而是一个平台.  多亏了libuv屏蔽了操作系统层面的差异, 优秀的js语言特性(有些人不以为然, 不评论)能让node做很多事情. 我们知道node擅长的部分是异步IO, 这里还是要感谢libuv, 但是不擅长的是CPU密集型操作, 这作为解释型脚本语言的弱项, 静态语言则反之表现出色. </p>
<h3 id="Node的C-C-模块"><a href="#Node的C-C-模块" class="headerlink" title="Node的C/C++模块"></a>Node的C/C++模块</h3><p>在朴老师的深浅node中指出, node with c++ module的fab数列计算数列与c语言不相上下, 当然C/C++作为node这一平台的补充是完全没有问题的, 但是这里朴老师明显是有误导读者的嫌疑(“感觉”node的计算速度比得上c). C/C++模块的另一大用处是可以获得系统的完全操作权限, 使用C的第三方lib, 完成js不能完成的任务, 例如线程层面的Sleep, 以及扩展node支持不好的crypto模块等等. 但是使用C/C++模块的时候, 要认识到我们其实是绕开了js/libuv提供的一些便利, 所以在开发的时候, 需要特别注意平台兼容性, 内存管理等等.</p>
<h3 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h3><p>之前给腾讯的微校开发CET无准考证查询功能, 由于api使用了加密手段, 导致调用起来比较麻烦, 得知其加密手法为CFB模式下64位的DES, 稍微查了一下node手册的crypto模块, 没有发现node对这个方法的支持, 而且考虑到js对加解密计算的弱项, 便打算借助C/C++模块配合openssl实现. 我们使用node-gyp工具进行模块的交叉编译, 由于nodejs4.0以上使用了新的C++ Compiler11标准, 所以需要更新到gcc &gt;=4.8才能对第三方C/C++模块进行编译, centos安装devtoolset3, ubuntu使用ppa源升级, 我在上一篇文章提到了<a href="https://www.zeroling.com/ubuntusheng-ji-gccdao-4-8/" target="_blank" rel="external">如何升级</a>.</p>
<h3 id="NAN模块"><a href="#NAN模块" class="headerlink" title="NAN模块"></a>NAN模块</h3><p>由于node各个版本使用的V8版本差异, 所以编写C/C++模块的时候语法差异比较大, 这里我们使用<a href="https://www.npmjs.com/package/nan" target="_blank" rel="external">nan</a>这个包抹平这些差异, nan提供了一个包含很多抹平差异宏定义实现的nan.h文件, 所以我们只要了解NAN这一套就可以了.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i nan --save</span><br></pre></td></tr></table></figure>
<p> 然后新建一个<code>binding.gyp</code>文件.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  "<span class="attribute">targets</span>": <span class="value">[</span><br><span class="line">    &#123;</span><br><span class="line">      "<span class="attribute">target_name</span>": <span class="value"><span class="string">"cetdecoder-main"</span></span>,</span><br><span class="line">      "<span class="attribute">sources</span>": <span class="value">[ <span class="string">"cetdecoder-main.cc"</span> ]</span>,</span><br><span class="line">      "<span class="attribute">include_dirs</span>": <span class="value">[ </span><br><span class="line">          <span class="string">"&lt;!(node -e \"require('nan')\")"</span></span><br><span class="line">      ]</span><br><span class="line">    </span>&#125;</span><br><span class="line">  ]</span><br><span class="line"></span>&#125;</span><br></pre></td></tr></table></figure>
<h3 id="C-C"><a href="#C-C" class="headerlink" title="C/C++"></a>C/C++</h3><p>先创建一个cc文件, 来看看里面的内容</p>
<p><img src="https://dn-redrock.qbox.me/cet-decoder-cc.png" alt="cet.cc"></p>
<p>这里添加了几个函数, 它的参数类型是<figure class="highlight"><figcaption><span>Nan::FunctionCallbackInfo<v8::value>& info```, 然后Init方法里的`exports`方法把这两个函数以"decodeTicket"和"encodeRequest"作为方法名暴露给node.  </v8::value></span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#10;&#36825;&#37324;&#21487;&#20197;&#30475;&#21040;, &#20174;`char*`&#24314;&#31435;&#19968;&#20010;v8&#20013;String&#31867;&#22411;&#23545;&#35937;&#30340;&#26041;&#27861;&#26159;: `Nan::New(&#34;string&#34;).ToLocalChecked()`, &#30456;&#21516;&#30340;&#21021;&#22987;&#21270;&#20989;&#25968;&#26159;`Nan::New&#60;v8::FunctionTemplate&#62;(&#8;func)-&#62;GetFunction()`.  &#10;&#10;&#26368;&#21518;&#30340;`NODE_MODULE`&#23439;&#23436;&#25104;&#25972;&#20010;&#23545;&#35937;&#30340;&#26292;&#38706;, &#36825;&#19968;&#21477;&#19982;`Init`&#26041;&#27861;&#30456;&#24403;&#20110;node&#20013;&#30340;&#10;&#10;``` javascript&#10;module.exports = &#123;&#10;  foo: bar&#10;&#125;</span><br></pre></td></tr></table></figure></p>
<p>再来看具体方法内的操作方法, 这里我们要关心的是如何将js中也就是V8的数据类型转化成c/c++的数据类型.</p>
<p><img src="https://dn-redrock.qbox.me/cet-decoder-cc-1.png" alt="func"></p>
<p>这个函数的需求是传入一个Buffer, 对Buffer中的二进制数据进行位解码操作后返回对应的Buffer.  </p>
<p>这里比较惭愧, 我翻了手册好几遍都没找到如何转化Buffer对象的方法(粗粗看了一下, doc的位置在node_modules/nan/doc), 为了方便, 我这里就传入一个数组, 例如<code>[0x41, 0x6d, 0x44, ...]</code>, 然后返回另一个数组. </p>
<p>当然我也没有找到如何转化数组的方法, 但是我找到了一个<code>args.Length()</code>的方法, 于是借助js的<code>apply</code>, 再在C中使用一个循环就ok了. 这里具体的获取某一个参数方法为<code>info[i]-&gt;NumberValue()</code>, 查<a href="http://izs.me/v8-docs/classv8_1_1Value.html" target="_blank" rel="external">V8手册</a>可知返回值是一个<code>double</code>类型, 这里我们根据需要转化成char类型的一个数组.  </p>
<p>接下来是返回的数组的创建.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">v8::Local&lt;v8::<span class="built_in">Array</span>&gt; retArr = Nan::New&lt;v8::<span class="built_in">Array</span>&gt;(len);</span><br><span class="line"><span class="keyword">for</span> (i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">  Nan::<span class="built_in">Set</span>(retArr, i, Nan::New(ret[i]));</span><br><span class="line">&#125;</span><br><span class="line">info.GetReturnValue().Set(retArr);</span><br></pre></td></tr></table></figure>
<h3 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-gyp configure&#10;node-gyp build</span><br></pre></td></tr></table></figure>
<p>也可以使用一句话build</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-gyp configure build</span><br></pre></td></tr></table></figure>
<p>生成的.node文件位于<code>./build/Release</code>, 可在node中直接require  </p>
<p>可以在<code>package.json</code>中加入<code>&quot;gypfile&quot;: true</code>让其自动编译</p>
<h3 id="需要注意的地方"><a href="#需要注意的地方" class="headerlink" title="需要注意的地方"></a>需要注意的地方</h3><p>其实这里我并没有使用NAN的example, nan的标准创建函数方法是使用NAN_METHOD宏.我建议参照NAN官方写法为了升级方便. </p>
<h3 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h3><p>因为做的比较急, 对V8的了解还不够深刻, 我甚至没有C++基础(只有很少的C), 例如Scope等概念还不是很清楚. 所以C/C++模块的开发对大部分前端工程师来说, 还真是一个技术活.   </p>
<p>这里是我的一个粗浅记录, 如果有什么不恰当的欢迎指出.</p>
<p>发表于我的博客<a href="https://www.zeroling.com" target="_blank" rel="external">Zero’s Corner</a>.</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://blog.zeroling.com/2015/12/07/shi-yong-cmo-kuai-wei-nodejstian-cai-zhu-li/" data-id="ciksc9aio000xchojvaz8ium7" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2015/12/28/2015nian-de-nian-zhong-zong-jie/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          2015年的年终总结
        
      </div>
    </a>
  
  
    <a href="/2015/12/03/ubuntusheng-ji-gccdao-4-8/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">UBUNTU升级GCC到4.8</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Linux-Mac/">
- Linux
- Mac</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Mac-重邮/">
- Mac
- 重邮</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/PJAX-AJAX/">
- PJAX
- AJAX</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPS-Apache-服务器/">
- VPS
- Apache
- 服务器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPS-服务器/">
- VPS
- 服务器</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPS-服务器-PHP/">
- VPS
- 服务器
- PHP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPS-服务器-备份-Dropbox/">
- VPS
- 服务器
- 备份
- Dropbox</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/VPS-服务器-备份-脚本/">
- VPS
- 服务器
- 备份
- 脚本</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/XSS/">
- XSS</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/javascript-HTML5/">
- javascript
- HTML5</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/js-chrome-googleapis/">
- js
- chrome
- googleapis</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nodejs-MD5-crypto/">
- nodejs
- MD5
- crypto</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端-HTTP-URL/">
- 前端
- HTTP
- URL</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端-underscore-javascript/">
- 前端
- underscore
- javascript</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/前端-服务器-HTTP/">
- 前端
- 服务器
- HTTP</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/寒假-总结/">
- 寒假
- 总结</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/小米-手机-改装-无线充电/">
- 小米
- 手机
- 改装
- 无线充电</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Linux-Mac/" style="font-size: 10px;">
- Linux
- Mac</a> <a href="/tags/Mac-重邮/" style="font-size: 10px;">
- Mac
- 重邮</a> <a href="/tags/PJAX-AJAX/" style="font-size: 10px;">
- PJAX
- AJAX</a> <a href="/tags/VPS-Apache-服务器/" style="font-size: 10px;">
- VPS
- Apache
- 服务器</a> <a href="/tags/VPS-服务器/" style="font-size: 10px;">
- VPS
- 服务器</a> <a href="/tags/VPS-服务器-PHP/" style="font-size: 10px;">
- VPS
- 服务器
- PHP</a> <a href="/tags/VPS-服务器-备份-Dropbox/" style="font-size: 10px;">
- VPS
- 服务器
- 备份
- Dropbox</a> <a href="/tags/VPS-服务器-备份-脚本/" style="font-size: 10px;">
- VPS
- 服务器
- 备份
- 脚本</a> <a href="/tags/XSS/" style="font-size: 10px;">
- XSS</a> <a href="/tags/javascript-HTML5/" style="font-size: 10px;">
- javascript
- HTML5</a> <a href="/tags/js-chrome-googleapis/" style="font-size: 10px;">
- js
- chrome
- googleapis</a> <a href="/tags/nodejs-MD5-crypto/" style="font-size: 10px;">
- nodejs
- MD5
- crypto</a> <a href="/tags/前端-HTTP-URL/" style="font-size: 10px;">
- 前端
- HTTP
- URL</a> <a href="/tags/前端-underscore-javascript/" style="font-size: 10px;">
- 前端
- underscore
- javascript</a> <a href="/tags/前端-服务器-HTTP/" style="font-size: 10px;">
- 前端
- 服务器
- HTTP</a> <a href="/tags/寒假-总结/" style="font-size: 10px;">
- 寒假
- 总结</a> <a href="/tags/小米-手机-改装-无线充电/" style="font-size: 10px;">
- 小米
- 手机
- 改装
- 无线充电</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/03/">March 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/02/">February 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/09/">September 2014</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/06/">June 2014</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2014/05/">May 2014</a><span class="archive-list-count">15</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/02/18/Hello-Hexo/">Hello Hexo</a>
          </li>
        
          <li>
            <a href="/2016/02/18/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/2015/12/28/2015nian-de-nian-zhong-zong-jie/">2015年的年终总结</a>
          </li>
        
          <li>
            <a href="/2015/12/07/shi-yong-cmo-kuai-wei-nodejstian-cai-zhu-li/">使用C++模块为Nodejs添彩助力</a>
          </li>
        
          <li>
            <a href="/2015/12/03/ubuntusheng-ji-gccdao-4-8/">UBUNTU升级GCC到4.8</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 Ling.<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">
  <script src="/fancybox/jquery.fancybox.pack.js" type="text/javascript"></script>


<script src="/js/script.js" type="text/javascript"></script>

  </div>
</body>
</html>